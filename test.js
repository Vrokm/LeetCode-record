require(["base/hwsdk"],function(t){t.init();var e=function(t,e,i){this.bestScore=t||0;this.config=e;this.domId=i||""};e.prototype={score:0,bestScore:0,isInit:false,musicManager:null,domId:null,device:{type:null,platform:null,width:0,height:0},canvasSize:{width:0,height:0,ratio:0},instance:null,playedMusic:false,initDevice:function(){this.device.width=game_width;this.device.height=game_height;if(game_width>game_height){this.device.width=game_height;this.device.height=game_width}this.device.platform=navigator.userAgent.toLowerCase().indexOf("android")<0?"apple":"android";this.device.type=this.device.width>700?"pad":"mobile"},initCanvasSize:function(){if(game_width<game_height){this.canvasSize.width=game_width*2;this.canvasSize.height=game_height*2;this.canvasSize.ratio=this.canvasSize.width/this.canvasSize.height}},toPlayMusic:function(){if(!this.playedMusic){this.musicManager.play("bg",true);this.playedMusic=true}},init:function(){t.showLoadingPage();var e=this;this.initDevice();this.initCanvasSize();this.isInit=true;this.instance=new Phaser.Game(this.canvasSize.width,this.canvasSize.height,Phaser.AUTO,this.domId);this.instance.States={};var a=this.instance;a.States.boot=function(){this.preload=function(){$(a.canvas).css("width",e.canvasSize.width/2);$(a.canvas).css("height",e.canvasSize.height/2);a.stage.backgroundColor="#aaa"};this.create=function(){a.state.start("preload")}};a.States.preload=function(){this.preload=function(){var i=showAd?true:false;setTimeout(function(){i=true},3e3);function s(){if(i==true){a.state.start("create")}else{setTimeout(function(){s()},1e3)}}a.load.crossOrigin="Anonymous";a.load.onLoadComplete.add(s);a.load.onFileComplete.add(function(e){t.configLoadingPage({progress:e})});var n=e.config["game"];if(n["bg"].indexOf("#")!=0){a.load.image("bg",n["bg"])}a.load.image("cat",n["cat"]);a.load.image("top",n["top"]);a.load.image("left",n["left"]);a.load.image("right",n["right"]);a.load.image("barrier",n["barrier"]);a.load.image("guide","//24haowan-cdn.shanyougame.com/uphill/assets/images/guide.png");a.load.audio("bg",n["music_bg"]);if(e.device.platform!="android"){a.load.audio("score",n["music_score"]);a.load.audio("dead",n["music_dead"]);a.load.audio("jump",n["music_jump"])}}};a.States.create=function(){this.create=function(){e.musicManager=new i(a,e.device,["bg","score","dead","jump"]);a.state.start("play")}};a.States.play=function(){this.create=function(){if(!e.playedMusic){a.paused=true;t.hideLoadingPage().showStartPage().showPageBtn();if(skip){a.paused=false;gameManager.toPlayMusic()}else{t.showBox()}}var i=this;if(e.config["game"]["bg"].indexOf("#")==0){a.stage.backgroundColor=e.config["game"]["bg"]}else{var s=a.add.image(0,0,"bg");s.width=e.canvasSize.width;s.height=e.canvasSize.height}var n=a.world.width/2;var r=a.world.height*.75;var o=false;e.score=0;var l=a.add.text(a.world.centerX,a.world.height*.15,"0",{fontSize:"100px",fill:"#ffffff"});l.anchor.setTo(.5,.5);var h=a.add.image(a.world.centerX,a.world.height*.8,"guide");h.anchor.setTo(.5,.5);h.scale.setTo(a.world.width*.6/h.width,a.world.width*.6/h.width);var c=a.add.sprite(n,r,"cat");c.width=a.world.width/5*.6;c.height=a.world.width/5*.6;c.anchor.setTo(.5,1);c.jumpEnable=true;c.currentI=0;c.currentJ=0;c.nextStep=null;c.isLive=true;c.jump=function(t){var i=t=="left"?-1:1;c.currentJ+=i;c.currentI--;this.scale.x=i*Math.abs(this.scale.x);this.jumpEnable=false;var s=a.add.tween(c).to({y:c.y-u.cubeWidth*.4},75,"Linear",true,0,0,true);s.onComplete.add(function(){c.y=r});var n=a.add.tween(u.group).to({x:u.group.x-i*u.cubeWidth/2,y:-c.currentI*u.cubeWidth*.5},150,"Linear",true,0,0,false);n.onComplete.add(function(){if(!c.isDead()){if(!c.nextStep){c.jumpEnable=true}else{var t=c.nextStep;c.nextStep=null;c.jump(t)}}});if(h){var d=h;h=null;var f=a.add.tween(d).to({alpha:0},300,"Linear",true,0,0,false);f.onComplete.add(function(){d.destroy()})}u.newRow();e.score+=100;l.text=e.score;if(e.score%10==0){e.musicManager.play("score");if(l.scale.x<=1){var g=a.add.tween(l.scale).to({x:1.5,y:1.5},200,"Linear",true,0,0,true)}}if(!o){o=true;u.autoKill()}else if(c.currentI-u.lastI<=-6){u.killLast()}e.musicManager.play("jump")};c.isDead=function(){var t=null;u.rows[-this.currentI].forEach(function(e){if(e.locationX==c.currentJ&&e.locationY==c.currentI)t=e.type});if(!t){c.fall(false);return true}else if(t==2){c.cooked();return true}return false};c.fall=function(t){c.isLive=false;c.jumpEnable=false;u.killTimer.stop(true);e.musicManager.play("dead");if(t){var s=a.add.tween(c).to({y:c.y-u.cubeWidth,angle:c.scale.x>0?30:-30},200,"Linear",true,0,0,false);s.onComplete.add(function(){var t=a.add.tween(c).to({y:c.y+a.world.height/2+u.cubeWidth*2},1e3,"Linear",true,0,0,false);t.onComplete.add(function(){i.gameEnd()})})}else{var n=a.add.tween(c).to({y:c.y+a.world.height/2+u.cubeWidth,angle:c.scale.x>0?150:-150},1e3,"Linear",true,0,0,false);n.onComplete.add(function(){i.gameEnd()})}};c.cooked=function(){c.isLive=false;u.killTimer.stop(true);c.jumpEnable=false;e.musicManager.play("dead");var t=a.add.tween(c).to({y:c.y-u.cubeWidth,angle:c.scale.x>0?30:-30},200,"Linear",true,0,0,false);t.onComplete.add(function(){var t=a.add.tween(c).to({y:c.y+a.world.height/2+u.cubeWidth*2},1e3,"Linear",true,0,0,false);t.onComplete.add(function(){i.gameEnd()})})};var d=function(){this.cubeWidth=a.world.width/5;this.group=a.add.group();this.startX=n;this.startY=r};d.prototype={group:null,cubeWidth:0,currentI:0,lastI:0,startX:0,startY:0,rows:[],lastCross:3,lastLocation:{x:0,y:0},killTime:2e3,killTimer:null,cubeBitmap:{normal:null,wrong:[],prize:[]},create:function(t,e,i){if(i==1){var s=this.cubeBitmap.normal}else if(i==2){var s=this.cubeBitmap.wrong[0]}var n=parseInt(this.startX+t*this.cubeWidth/2);var r=parseInt(this.startY+(e-2)*this.cubeWidth*.5);var o=this.group.create(n,r,s);o.type=i;o.locationX=t;o.locationY=e;o.alpha=0;o.anchor.setTo(.5,.5);var l=a.add.tween(o).to({alpha:1,y:this.startY+e*this.cubeWidth*.5},200,"Linear",true,0,0,false);if(this.rows[-this.currentI-1]){for(var h in this.rows[-this.currentI-1]){if(this.rows[-this.currentI-1][h].type==2)this.rows[-this.currentI-1][h].bringToTop();if(c)c.bringToTop()}}if(this.rows[-this.currentI-2]){for(var h in this.rows[-this.currentI-2]){if(this.rows[-this.currentI-2][h].type==2)this.rows[-this.currentI-2][h].bringToTop();if(c)c.bringToTop()}}if(!this.rows[-this.currentI])this.rows[-this.currentI]=[];this.rows[-this.currentI].push(o)},init:function(){var t=parseInt(this.cubeWidth);var e=parseInt(this.cubeWidth*.75);this.cubeBitmap.normal=a.add.bitmapData(t,e);this.drawCube(this.cubeBitmap.normal.ctx,this.cubeWidth/2,this.cubeWidth/4,{left:a.cache.getImage("left"),top:a.cache.getImage("top"),right:a.cache.getImage("right")});this.cubeBitmap.wrong[0]=a.add.bitmapData(t,parseInt(this.cubeWidth*1.75));this.drawCube(this.cubeBitmap.wrong[0].ctx,this.cubeWidth/2,this.cubeWidth/4,{left:a.cache.getImage("left"),top:a.cache.getImage("top"),right:a.cache.getImage("right")},a.cache.getImage("barrier"));this.create(0,0,1);for(var i=0;i<5;i++){this.newRow(true);if(i==0){c.scale.x*=this.lastLocation.x<0?-1:1}}},newRow:function(t){if(this.lastCross<=0){var e=t?false:Math.random()>.9?true:false;if(e)this.lastCross=3}else{var e=false}if(e){var i=Math.random()>.5?1:-1;var a=this.lastLocation.x+i;this.create(a,--this.currentI,1);var s=this.lastLocation.x-i;this.create(s,this.currentI,2)}else{var a=this.lastLocation.x+(Math.random()>.5?1:-1);this.create(a,--this.currentI,1)}this.lastLocation.x=a;this.lastLocation.y=this.currentI;this.lastCross--},drawCube:function(t,e,i,a,s){var n=s?e:0;t.beginPath();t.setTransform(1,.5,0,1,0,0);t.drawImage(a.left,0,e/2+n,e,i);t.beginPath();t.setTransform(1,-.5,0,1,0,0);t.drawImage(a.right,e,3*e/2+n,e,i);var r=document.createElement("canvas");var o=r.getContext("2d");o.beginPath();o.setTransform(1,0,.6,.8,0,0);o.drawImage(a.top,0,0,e*Math.sqrt(5)/2,e*Math.sqrt(5)/2);t.beginPath();t.setTransform(1,0,0,1,0,e/2+n);t.rotate(-Math.asin(1/Math.sqrt(5)));t.drawImage(r,0,0);if(s){t.setTransform(1,0,0,1,0,0);t.drawImage(s,.25*e,e*.275,e*1.5,e*1.5)}},shadeColor:function(t,e){t=t.substr(1);var i=parseInt(t,16),a=Math.round(2.55*e),s=(i>>16)+a,n=(i>>8&255)+a,r=(i&255)+a;return"#"+(16777216+(s<255?s<1?0:s:255)*65536+(n<255?n<1?0:n:255)*256+(r<255?r<1?0:r:255)).toString(16).slice(1)},autoKill:function(){this.killTimer=a.time.create(false);if(game_id==1163487721){this.killTimer.repeat(this.killTime*1.5,1,this.killLast)}else{this.killTimer.repeat(this.killTime,1,this.killLast)}this.killTimer.start()},killLast:function(){if(this.killTimer)this.killTimer.stop(true);u.rows[-u.lastI].forEach(function(t){if(typeof t=="number"){killI=t}else{var e=a.add.tween(t).to({alpha:0,y:t.y+a.world.height/4+u.cubeWidth},375,"Linear",true,0,0,false);e.onComplete.add(function(){t.destroy()})}});u.killTime-=40;u.killTime=u.killTime<165?165:u.killTime;if(c.isLive){if(u.lastI==c.currentI){c.fall(true)}else{u.lastI--;u.autoKill()}}}};var u=new d;u.init();setTimeout(function(){a.input.onDown.removeAll();a.input.onDown.add(function(t){var e;if(t.x<a.world.width/4){e="left"}else{e="right"}if(c.jumpEnable){if(c.nextStep){c.nextStep=e}else{c.jump(e)}}else{c.nextStep=e}})},500)};this.update=function(){};this.gameEnd=function(){if(skip){a.state.start("play")}else{var i=e.score;t.requestGameScore({game_score:488,game_id:game_info["game_id"],device_type:e.device.platform},function(){t.showOverPage().showPageBtn().showBox()});var s=t.getWxShareObj();var n=/\{score\}/gi;s.link=s.link+"?score="+i;if(i!=0){s["title"]=s["title"].replace(n,function(){return i});s["desc"]=s["desc"].replace(n,function(){return i})}t.setWxShare(s,i);a.state.start("end")}}};a.States.end=function(){this.create=function(){}};a.state.add("boot",a.States.boot);a.state.add("preload",a.States.preload);a.state.add("create",a.States.create);a.state.add("play",a.States.play);a.state.add("end",a.States.end);a.state.start("boot")}};var i=function(t,e,i){this.gameInstance=t;this.deviceInfo=e;this.assets=i;this.init()};i.prototype={gameInstance:null,deviceInfo:null,assets:null,musicObject:null,isBaned:false,isPlaying:false,playingList:[],init:function(){var t=this;if(this.assets){this.musicObject={};for(var e=0,i=this.assets.length;e<i;e++){var a=this.gameInstance.add.audio(this.assets[e]);a.name=this.assets[e];a.onPause.add(function(){t.playingList=t.playingList.splice(t.playingList.indexOf(a.name),1);if(t.playingList.length==0)t.isPlaying=false});a.onStop.add(function(){t.playingList=t.playingList.splice(t.playingList.indexOf(a.name),1);if(t.playingList.length==0)t.isPlaying=false});this.musicObject[this.assets[e]]=a}}},play:function(t,e){if(!this.isBaned){var i=false;if(this.deviceInfo.platform=="apple"){i=true}else if(this.deviceInfo.platform=="android"&&!this.isPlaying){i=true}if(i){if(e){if(!this.musicObject[t].isPlaying){this.musicObject[t].loopFull();this.playingList.push(t)}}else{this.musicObject[t].play();if(!this.musicObject[t].isPlaying){this.playingList.push(t)}}this.isPlaying=true}}},resume:function(){for(var t in this.playingList){var e=this.playingList[t];this.musicObject[e].resume()}this.isPlaying=true},pause:function(){for(var t in this.playingList){var e=this.playingList[t];this.musicObject[e].pause()}this.isPlaying=false},stop:function(){for(var t in this.playingList){var e=this.playingList[t];this.musicObject[e].stop()}this.isPlaying=false;this.playingList=[]},ban:function(){this.isBaned=true;this.pause()},disban:function(){this.isBaned=false;this.resume()}};gameManager=new e(bestScore,configJson,"game_div");a(t.getDeviceOrientation());t.onOrientationChanged(a);function a(e){if(e=="portrait"){t.hideRotateMask();if(gameManager.isInit)game.paused=false;if(!gameManager.isInit)gameManager.init()}else if(e=="landscape"){t.showRotateMask();if(gameManager.isInit)game.paused=true}else if(t.detectDevice()=="pc"){gameManager.init()}else if(e=="undefined"&&t.detectDevice()=="mobile"){gameManager.init()}}});